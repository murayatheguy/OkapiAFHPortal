i need to add my places api google. Goal is autocomplete but i also want to scrub google profiles of the afhs for pictures

9:56 PM




Synthesized API integration strategy for location search and profile scraping.



## Task: Integrate Google Places API for Autocomplete and Facility Photos

### Overview

Add Google Places API to:
1. Enable location autocomplete in search bar
2. Fetch photos from Google Business Profiles for AFH facilities

---

### Part 1: Location Autocomplete

#### Setup

Add Google Places API script to your app:
```html
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
```

Or if using React, install:
```bash
npm install @react-google-maps/api
```

#### Implement Autocomplete on Search Bar

When user types in location field, show Google Places suggestions:
```javascript
// React example
import { useLoadScript, Autocomplete } from '@react-google-maps/api';

const libraries = ['places'];

function LocationSearch() {
  const { isLoaded } = useLoadScript({
    googleMapsApiKey: process.env.GOOGLE_MAPS_API_KEY,
    libraries,
  });

  const [autocomplete, setAutocomplete] = useState(null);
  const [location, setLocation] = useState('');

  const onLoad = (autocompleteInstance) => {
    setAutocomplete(autocompleteInstance);
  };

  const onPlaceChanged = () => {
    if (autocomplete) {
      const place = autocomplete.getPlace();
      
      // Get location details
      const locationData = {
        formatted_address: place.formatted_address,
        city: place.address_components?.find(c => c.types.includes('locality'))?.long_name,
        state: place.address_components?.find(c => c.types.includes('administrative_area_level_1'))?.short_name,
        zip: place.address_components?.find(c => c.types.includes('postal_code'))?.long_name,
        lat: place.geometry?.location?.lat(),
        lng: place.geometry?.location?.lng(),
      };
      
      setLocation(locationData);
      // Trigger search with this location
    }
  };

  if (!isLoaded) return <div>Loading...</div>;

  return (
    <Autocomplete
      onLoad={onLoad}
      onPlaceChanged={onPlaceChanged}
      options={{
        componentRestrictions: { country: 'us' },
        types: ['(cities)'], // or ['address'] or ['geocode']
      }}
    >
      <input
        type="text"
        placeholder="Enter city or zip code"
        className="your-existing-input-class"
      />
    </Autocomplete>
  );
}
```

#### Restrict to Washington State (Optional)
```javascript
options={{
  componentRestrictions: { country: 'us' },
  bounds: {
    north: 49.0024,  // WA north border
    south: 45.5435,  // WA south border
    east: -116.9165, // WA east border
    west: -124.8489, // WA west border
  },
  strictBounds: false, // Set true to ONLY show WA results
}}
```

---

### Part 2: Fetch Google Business Profile Photos for AFHs

#### Strategy

For each AFH facility:
1. Search Google Places API using facility name + address
2. Get the Place ID
3. Fetch photos using Place Details API
4. Store photo URLs in database

#### Step 1: Find Place ID
```javascript
async function findGooglePlaceId(facility) {
  const query = `${facility.name} ${facility.address} ${facility.city} ${facility.state}`;
  
  const response = await fetch(
    `https://maps.googleapis.com/maps/api/place/findplacefromtext/json?` +
    `input=${encodeURIComponent(query)}` +
    `&inputtype=textquery` +
    `&fields=place_id,name,formatted_address,photos` +
    `&key=${process.env.GOOGLE_MAPS_API_KEY}`
  );
  
  const data = await response.json();
  
  if (data.candidates && data.candidates.length > 0) {
    return data.candidates[0].place_id;
  }
  
  return null;
}
```

#### Step 2: Fetch Place Details with Photos
```javascript
async function fetchGooglePlaceDetails(placeId) {
  const response = await fetch(
    `https://maps.googleapis.com/maps/api/place/details/json?` +
    `place_id=${placeId}` +
    `&fields=name,formatted_address,photos,rating,user_ratings_total,reviews,opening_hours,website,formatted_phone_number` +
    `&key=${process.env.GOOGLE_MAPS_API_KEY}`
  );
  
  const data = await response.json();
  return data.result;
}
```

#### Step 3: Get Photo URLs
```javascript
function getPhotoUrl(photoReference, maxWidth = 800) {
  return `https://maps.googleapis.com/maps/api/place/photo?` +
    `maxwidth=${maxWidth}` +
    `&photo_reference=${photoReference}` +
    `&key=${process.env.GOOGLE_MAPS_API_KEY}`;
}

async function fetchFacilityPhotos(facility) {
  // Find place
  const placeId = await findGooglePlaceId(facility);
  
  if (!placeId) {
    console.log(`No Google Place found for: ${facility.name}`);
    return null;
  }
  
  // Get details
  const placeDetails = await fetchGooglePlaceDetails(placeId);
  
  if (!placeDetails.photos || placeDetails.photos.length === 0) {
    console.log(`No photos found for: ${facility.name}`);
    return null;
  }
  
  // Build photo URLs
  const photos = placeDetails.photos.map(photo => ({
    url: getPhotoUrl(photo.photo_reference),
    width: photo.width,
    height: photo.height,
    attributions: photo.html_attributions,
  }));
  
  return {
    placeId,
    googleRating: placeDetails.rating,
    googleReviewCount: placeDetails.user_ratings_total,
    website: placeDetails.website,
    phone: placeDetails.formatted_phone_number,
    photos,
  };
}
```

#### Step 4: Batch Process All AFHs
```javascript
async function syncGooglePhotosForAllFacilities() {
  // Get all AFH facilities without photos
  const facilities = await db.facilities.findMany({
    where: {
      facilityType: 'afh',
      google_place_id: null, // Not yet synced
    },
  });
  
  console.log(`Syncing ${facilities.length} facilities...`);
  
  for (const facility of facilities) {
    try {
      const googleData = await fetchFacilityPhotos(facility);
      
      if (googleData) {
        await db.facilities.update({
          where: { id: facility.id },
          data: {
            google_place_id: googleData.placeId,
            google_rating: googleData.googleRating,
            google_review_count: googleData.googleReviewCount,
            google_photos: googleData.photos,
            google_synced_at: new Date(),
          },
        });
        
        console.log(`âœ“ Synced: ${facility.name}`);
      }
      
      // Rate limiting - wait between requests
      await sleep(200); // 200ms delay
      
    } catch (error) {
      console.error(`Error syncing ${facility.name}:`, error);
    }
  }
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}
```

---

### Part 3: Database Schema Update

Add fields to store Google data:
```sql
ALTER TABLE facilities ADD COLUMN google_place_id VARCHAR(255);
ALTER TABLE facilities ADD COLUMN google_rating DECIMAL(2,1);
ALTER TABLE facilities ADD COLUMN google_review_count INTEGER;
ALTER TABLE facilities ADD COLUMN google_photos JSONB;
ALTER TABLE facilities ADD COLUMN google_synced_at TIMESTAMP;
```

Or in Prisma:
```prisma
model Facility {
  // ... existing fields
  
  google_place_id     String?
  google_rating       Float?
  google_review_count Int?
  google_photos       Json?     // Array of photo objects
  google_synced_at    DateTime?
}
```

---

### Part 4: Display Photos on Facility Cards
```javascript
function FacilityCard({ facility }) {
  // Prioritize: Owner uploaded photos > Google photos > Placeholder
  const photos = facility.owner_photos?.length > 0 
    ? facility.owner_photos 
    : facility.google_photos?.length > 0
      ? facility.google_photos.map(p => p.url)
      : ['/placeholder-facility.jpg'];
  
  return (
    <div className="facility-card">
      <div className="photo-carousel">
        {photos.map((photo, index) => (
          <img key={index} src={photo} alt={`${facility.name} photo ${index + 1}`} />
        ))}
      </div>
      
      {/* Show Google attribution if using Google photos */}
      {!facility.owner_photos?.length && facility.google_photos?.length > 0 && (
        <span className="photo-attribution">Photos from Google</span>
      )}
      
      {/* Rest of card... */}
    </div>
  );
}
```

---

### Part 5: Environment Variables

Add to your `.env`:
```env
GOOGLE_MAPS_API_KEY=your_api_key_here
```

Make sure API key has these APIs enabled in Google Cloud Console:
- Maps JavaScript API
- Places API
- Geocoding API

---

### Part 6: API Restrictions (Important for Security)

In Google Cloud Console, restrict your API key:

**For frontend (autocomplete):**
- Application restrictions: HTTP referrers
- Add: `okapicarenetwork.com/*` and `localhost:*` (for dev)

**For backend (photo fetching):**
- Create a separate API key
- Application restrictions: IP addresses
- Add your server IP

---

### Acceptance Criteria

**Autocomplete:**
- [ ] Location search field has autocomplete dropdown
- [ ] Suggestions appear as user types
- [ ] Selecting a location populates city/state/lat/lng
- [ ] Search triggers with selected location
- [ ] Works on mobile

**Photo Fetching:**
- [ ] Script to batch fetch Google Place data for AFHs
- [ ] Photos stored in database
- [ ] Google rating and review count stored
- [ ] Facility cards display Google photos when no owner photos exist
- [ ] "Photos from Google" attribution shown
- [ ] Rate limiting prevents API quota issues

**Error Handling:**
- [ ] Graceful handling when no Google Place found
- [ ] Graceful handling when no photos available
- [ ] Fallback to placeholder image

---

### Cost Considerations

Google Places API pricing:
- Find Place: $17 per 1,000 requests
- Place Details: $17 per 1,000 requests
- Place Photos: $7 per 1,000 requests

For 3,200 AFHs (one-time sync):
- Find Place: ~$55
- Place Details: ~$55
- Photos (avg 3 per facility): ~$67
- **Total one-time: ~$180**

Autocomplete:
- $2.83 per 1,000 sessions

---

### Optional: Cron Job for Regular Sync
```javascript
// Run weekly to catch new photos/reviews
cron.schedule('0 3 * * 0', async () => {
  console.log('Starting weekly Google sync...');
  await syncGooglePhotosForAllFacilities();
});
```
This gives Replit everything needed to add autocomplete and fetch Google Business photos. Want me to add anything about handling the photo attribution requirements or caching strategy?